<script>
  let currentSong = 1;

  function getAudioSrc(n) {
    switch (n) {
      case 1: return 'WhispersofErosion.mp3';
      case 2: return 'Metamorphosis.mp3';
      case 3: return 'Echoes.mp3';
      case 4: return 'Sea Frequency.mp3';
      default: return '';
    }
  }

  function isTabletOrDesktop() {
    return window.innerWidth > 600;
  }

  function pauseAllAudio() {
    document.querySelectorAll('audio').forEach(audio => {
      audio.pause();
      audio.currentTime = 0;
    });
  }

  function removeAllAudio() {
    document.querySelectorAll('.song audio').forEach(audio => audio.remove());
  }

  function enterSite() {
    // 確保全部頁面狀態清除
    document.getElementById('home').style.display = 'none';
    document.getElementById('main').classList.add('hidden');
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('menu-mobile').classList.add('hidden');
    pauseAllAudio();
    removeAllAudio();

    if (isTabletOrDesktop()) {
      document.getElementById('menu').classList.remove('hidden');
    } else {
      document.getElementById('menu-mobile').classList.remove('hidden');
    }
  }

  function openSong(n) {
    pauseAllAudio();
    removeAllAudio();
    currentSong = n;

    document.getElementById('home').style.display = 'none';
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('menu-mobile').classList.add('hidden');
    document.getElementById('main').classList.remove('hidden');

    const slider = document.getElementById('slider');
    slider.scrollTo({ left: (n - 1) * slider.clientWidth, behavior: 'auto' });

    addAudioToSong(n);
    window.scrollTo(0, document.body.scrollHeight);
  }

  function addAudioToSong(n) {
    const targetSong = document.getElementById(`song${n}`);
    const newAudio = document.createElement('audio');
    newAudio.controls = true;
    newAudio.src = getAudioSrc(n);
    newAudio.style.position = 'absolute';
    newAudio.style.bottom = '100px';
    newAudio.style.left = '50%';
    newAudio.style.transform = 'translateX(-50%)';
    newAudio.style.width = '90%';
    newAudio.style.maxWidth = '400px';
    newAudio.setAttribute('playsinline', '');
    newAudio.setAttribute('preload', 'auto');
    targetSong.appendChild(newAudio);
  }

  function scrollToSong() {
    const slider = document.getElementById('slider');
    slider.scrollTo({ left: (currentSong - 1) * slider.clientWidth, behavior: 'smooth' });
    removeAllAudio();
    addAudioToSong(currentSong);
  }

  function prevSong() {
    if (currentSong === 1) {
      back();
      return;
    }
    pauseAllAudio();
    currentSong--;
    scrollToSong();
  }

  function nextSong() {
    if (currentSong === 4) return;
    pauseAllAudio();
    currentSong++;
    scrollToSong();
  }

  function back() {
    pauseAllAudio();
    removeAllAudio();
    document.getElementById('main').classList.add('hidden');
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('menu-mobile').classList.add('hidden');
    document.getElementById('home').style.display = 'block';
  }

  // 修正滑動時 audio 不見
  document.getElementById('slider').addEventListener('scroll', function () {
    const index = Math.round(this.scrollLeft / this.clientWidth) + 1;
    if (index !== currentSong) {
      currentSong = index;
      pauseAllAudio();
      removeAllAudio();
      addAudioToSong(currentSong);
    }
  });

  // 移動端播放修正
  document.addEventListener('touchstart', () => {
    document.querySelectorAll('audio').forEach(audio => {
      audio.controls = true;
    });
  }, { once: true });
</script>

